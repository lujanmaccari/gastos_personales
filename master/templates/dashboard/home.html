{% extends 'layout/frame.html' %}

{% block title %}
  Dashboard
{% endblock %}

{% load currency_filters %}


{% block sectionTitle %}
  Hola {{ request.user }} üëã, este mes llev√°s gastado {{ total_gastos_mes|format_currency:user_currency }}
{% endblock %}

{% load static %}

{% block contenido_tabla %}
  <div class="flex flex-col w-full">

    <!-- INDICADOR DE MONEDA ACTUAL -->
    <div class="mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-3 border border-blue-200 dark:border-blue-800">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">payments</span>
          <p class="text-sm text-gray-700">
            Moneda actual: <span class="font-bold text-blue-600 dark:text-blue-400">{{ user_currency }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- TARJETAS -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6">
      <!-- CARD: INGRESOS -->
      <div class="flex flex-col gap-2 rounded-xl p-6 bg-white/70 dark:bg-background-dark/50 shadow-sm">
        <p class="text-[#0e171b] text-base font-medium">Total de ingresos üí∞</p>

        <div class="flex items-baseline gap-2">
          <p class="text-[#0e171b] text-3xl font-bold">{{ total_ingresos_mes|format_currency:user_currency }}</p>

          {% if crecimiento_ingresos > 0 %}
            <div class="flex items-center gap-1 text-green-600">
              <span class="material-symbols-outlined text-sm">arrow_upward</span>
              <span class="text-sm font-medium">+{{ crecimiento_ingresos }}% vs. mes pasado</span>
            </div>
          {% elif crecimiento_ingresos < 0 %}
            <div class="flex items-center gap-1 text-red-600">
              <span class="material-symbols-outlined text-sm">arrow_downward</span>
              <span class="text-sm font-medium">-{{ crecimiento_ingresos }}% vs. mes pasado</span>
            </div>
          {% else %}
            <span class="text-gray-600 text-sm">0%</span>
          {% endif %}
        </div>
      </div>

      <!-- CARD: GASTOS -->
      <div class="flex flex-col gap-2 rounded-xl p-6 bg-white/70 dark:bg-background-dark/50 shadow-sm">
        <p class="text-[#0e171b] text-base font-medium">Total de gastos üí∏</p>

        <div class="flex items-baseline gap-2">
          <p class="text-[#0e171b] text-3xl font-bold">{{ total_gastos_mes|format_currency:user_currency }}</p>

          <!-- CRECIMIENTO DE GASTOS -->
          {% if crecimiento_gastos > 0 %}
            <div class="flex items-center gap-1 text-red-600">
              <span class="material-symbols-outlined text-sm">arrow_upward</span>
              <span class="text-sm font-medium">+{{ crecimiento_gastos }}% vs. mes pasado</span>
            </div>
          {% elif crecimiento_gastos < 0 %}
            <div class="flex items-center gap-1 text-green-600">
              <span class="material-symbols-outlined text-sm">arrow_downward</span>
              <span class="text-sm font-medium">-{{ crecimiento_gastos }}% vs. mes pasado</span>
            </div>
          {% else %}
            <div class="flex items-center gap-1 text-gray-500">
              <span class="material-symbols-outlined text-sm">horizontal_rule</span>
              <span class="text-sm font-medium">0%</span>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- CARD: BALANCE -->
      <div class="flex flex-col gap-2 rounded-xl p-6 bg-white/70 dark:bg-background-dark/50 shadow-sm">
        <p class="text-[#0e171b] text-base font-medium">Balance mensual ‚öñÔ∏è</p>

        <div class="flex items-baseline gap-2">
          <p class="text-[#0e171b] text-3xl font-bold"> {{ balance_mensual|format_currency:user_currency }}</p>

          {% if crecimiento_balance > 0 %}
            <div class="flex items-center gap-1 text-green-600">
              <span class="material-symbols-outlined text-sm">arrow_upward</span>
              <span class="text-sm font-medium">{{ crecimiento_balance }}% vs. mes pasado</span>
            </div>
          {% elif crecimiento_balance < 0 %}
            <div class="flex items-center gap-1 text-red-600">
              <span class="material-symbols-outlined text-sm">arrow_downward</span>
              <span class="text-sm font-medium">{{ crecimiento_balance }}% vs. mes pasado</span>
            </div>
          {% else %}
            <span class="text-gray-600 text-sm">0%</span>
          {% endif %}
        </div>
      </div>

      <!-- CARD: TOP CATEGORIA -->
      <div class="flex flex-col gap-2 rounded-xl p-6 bg-white/70 dark:bg-background-dark/50 shadow-sm">
        <p class="text-[#0e171b] text-base font-medium">Top categor√≠a del mes üèÜ</p>
        <p class="text-[#0e171b] text-3xl font-bold">{{ top_categoria_mes }}</p>
        <p class="text-xs text-gray-500 dark:text-gray-400">Mayor gasto del mes</p>
      </div>
    </div>

    <!-- GRAFICO -->
    <div class="mt-8 flex flex-col gap-2 rounded-xl border border-primary/20 p-6 bg-white/70 dark:bg-background-dark/50 shadow-sm">
      <p class="text-[#0e171b] text-lg font-bold">Evoluci√≥n de Gastos</p>

      <div class="flex gap-1 items-baseline">
        <p class="text-gray-600 dark:text-gray-400">√öltimos 6 meses</p>
        <p class="text-green-600 dark:text-green-400 font-medium">+5%</p>
      </div>

      <!-- CONTENEDOR CON ALTURA FIJA -->
      <div class="w-full flex flex-col gap-4 py-2">
        <!-- TARJETA DEL GRAFICO -->
        <div class="w-full">
          <canvas id="gastosChart" height="50"></canvas>
        </div>

        <!-- Meses debajo -->
        <div class="flex justify-around mt-1">
          {% for mes in ultimos_meses %}
            <p class="text-gray-500 dark:text-gray-400 text-sm font-bold">{{ mes }}</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <script>
    const labels = {{ ultimos_meses|safe }};
    const dataValues = {{ valores_gastos_mensuales|safe }};
    const userCurrency = '{{ user_currency }}';
  
    const ctx = document.getElementById('gastosChart');

     // Configurar s√≠mbolo de moneda
    const currencySymbols = {
      'ARS': '$',
      'USD': 'USD',
      'EUR': '‚Ç¨'
    };
    const currencySymbol = currencySymbols[userCurrency] || '$';
  
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Gastos Mensuales',
          data: dataValues,
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          borderColor: '#47b4eb',
          backgroundColor: 'rgba(71, 180, 235, 0.25)',
          pointRadius: 4,
          pointBackgroundColor: '#47b4eb',
        }]
      },
      options: {
        responsive: true,

        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  // Formatear seg√∫n la moneda
                  if (userCurrency === 'ARS') {
                    label += currencySymbol + context.parsed.y.toLocaleString('es-AR', {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2
                    });
                  } else {
                    label += currencySymbol + context.parsed.y.toLocaleString('en-US', {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2
                    });
                  }
                }
                return label;
              }
            }
          }
        },

        scales: {
          y: {
            ticks: {
              callback: value => '$' + value.toLocaleString('es-AR')
            },
            beginAtZero: false
          }
        }
      }
    });
  </script>
{% endblock %}