{% extends 'layout/frame.html' %}

{% block title %}Gastos{% endblock %}
{% block sectionTitle %}Mis Gastos{% endblock %}

{% block nuevo_modal_url %}
  {% url 'gastos_create' %}
{% endblock %}

{% block contenido_tabla %}

<div class="w-full space-y-4">

  <!-- SECCIÓN: BÚSQUEDA Y FILTROS -->
  <div class="flex flex-col lg:flex-row gap-4">
    
    <!-- Barra de Búsqueda -->
    <div class="flex-grow">
      <form method="get" action="{% url 'gastos' %}" class="w-full">
        <label class="flex flex-col h-12 w-full">
          <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
            <div class="flex bg-gray-100 items-center justify-center pl-4 rounded-l-xl border-r-0">
              <i class="fas fa-search text-gray-500"></i>
            </div>
            <input 
              type="text"
              name="search"
              value="{{ search_query }}"
              class="form-input flex w-full min-w-0 flex-1 rounded-r-xl focus:outline-0 focus:ring-2 focus:ring-blue-500 border-none bg-gray-100 h-full placeholder:text-gray-500 px-4 text-base"
              placeholder="Buscar gastos..."/>
          </div>
        </label>
      </form>
    </div>

    <!-- Botones de Filtros -->
    <div class="flex gap-3 flex-wrap">
      <button 
        onclick="toggleFiltros()"
        class="flex h-12 shrink-0 items-center justify-center gap-x-2 rounded-xl bg-gray-100 hover:bg-gray-200 px-4 transition">
        <i class="fas fa-filter text-gray-700"></i>
        <p class="text-gray-900 text-sm font-medium">Filtros</p>
      </button>
      
    </div>
  </div>

  <!-- Panel de Filtros Colapsable -->
  <div id="filtrosPanel" class="hidden">
    <form method="get" action="{% url 'gastos' %}" class="p-6 bg-white border border-gray-200 rounded-xl shadow-sm">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        
        <!-- Filtro: Categoría -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
          <select 
            name="categoria"
            class="input w-full bg-gray-50 border-gray-300 rounded-xl">
            <option value="">Todas</option>
            {% for categoria in categorias_disponibles %}
            <option value="{{ categoria.id }}" 
              {% if filtro_categoria == categoria.id|stringformat:"s" %}selected{% endif %}>
              {{ categoria.nombre }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Filtro: Fecha -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
          <input 
            type="date"
            name="fecha"
            value="{{ filtro_fecha }}"
            class="input w-full bg-gray-50 border-gray-300 rounded-xl"/>
        </div>

        <!-- Filtro: Monto Mínimo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Monto mín.</label>
          <input 
            type="number"
            step="0.01"
            name="monto_min"
            value="{{ filtro_monto_min }}"
            placeholder="Ej: 10"
            class="input w-full bg-gray-50 border-gray-300 rounded-xl"/>
        </div>

        <!-- Filtro: Monto Máximo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Monto máx.</label>
          <input 
            type="number"
            step="0.01"
            name="monto_max"
            value="{{ filtro_monto_max }}"
            placeholder="Ej: 100"
            class="input w-full bg-gray-50 border-gray-300 rounded-xl"/>
        </div>

      </div>

      <!-- Boton del formulario -->
      <div class="flex gap-3 mt-4 justify-end">
        <button 
          type="submit"
          class="btn bg-blue-500 hover:bg-blue-600 text-white px-6">
          <i class="fas fa-search mr-2"></i> Aplicar
        </button>
        
        {% if search_query or filtro_categoria or filtro_fecha or filtro_monto_min or filtro_monto_max %}
        <a 
          href="{% url 'gastos' %}"
          class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-6">
          <i class="fas fa-times mr-2"></i> Limpiar
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- SECCIÓN: TABLA Y GRÁFICO -->
  <div class="flex flex-col lg:flex-row gap-6">

    <!-- TABLA DE GASTOS (Izquierda - 2/3) -->
    <div class="flex-grow w-full lg:w-2/3">
      {% if gastos %}
      <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
        <table class="w-full">
          <thead>
            <tr class="bg-gray-50">
              <th class="px-4 py-3 text-left text-gray-600 text-sm font-medium">Fecha</th>
              <th class="px-4 py-3 text-left text-gray-600 text-sm font-medium">Categoría</th>
              <th class="px-4 py-3 text-left text-gray-600 text-sm font-medium">Descripción</th>
              <th class="px-4 py-3 text-right text-gray-600 text-sm font-medium">Monto</th>
              <th class="px-4 py-3 text-center text-gray-600 font-medium">Acciones</th>
            </tr>
          </thead>
          
          <tbody>
            {% for gasto in gastos %}
            <tr class="border-t border-gray-200 hover:bg-gray-50 transition-colors">
              
              <!-- Fecha -->
              <td class="px-4 py-4 text-gray-500 text-sm">
                {{ gasto.fecha|date:"d/m/Y" }}
              </td>

              <!-- Categoría con Badge -->
              <td class="px-4 py-4">
                {% for item in gastos_por_categoria %}
                  {% if item.categoria == gasto.categoria.nombre %}
                  <div class="flex items-center gap-2">
                    <i class="{{ item.icono }} {{ item.color_icono }}"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium {{ item.color_badge }}">
                      {{ gasto.categoria.nombre }}
                    </span>
                  </div>
                  {% endif %}
                {% endfor %}
              </td>

              <!-- Descripción -->
              <td class="px-4 py-4 text-gray-700 text-sm">
                {{ gasto.descripcion|default:"—"|truncatewords:10 }}
              </td>

              <!-- Monto -->
              <td class="px-4 py-4 text-gray-500 text-sm text-right font-medium">
                ${{ gasto.monto|floatformat:2 }}
              </td>

              <!-- Acciones -->
              <td class="px-4 py-3">
                <div class="flex justify-center gap-3">
                  <a href="{% url 'gastos_update' gasto.id %}" 
                    class="text-blue-500 hover:text-blue-700 transition"
                    title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'gastos_delete' gasto.id %}" 
                    class="text-red-500 hover:text-red-700 transition"
                    title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </div>
              </td>

            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
      <div class="mt-4 flex justify-center">
        <div class="flex gap-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" 
            class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-700 transition">
            Anterior
          </a>
          {% endif %}
          
          <span class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium">
            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" 
            class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-700 transition">
            Siguiente
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% else %}
      <!-- Estado vacío -->
      <div class="text-center py-16 bg-white border border-gray-200 rounded-xl">
        <i class="fas fa-receipt text-gray-300 text-6xl mb-4"></i>
        <p class="text-gray-500 text-lg mb-4">No hay gastos registrados</p>
        <a href="{% url 'gastos_create' %}" 
          class="btn bg-blue-500 hover:bg-blue-600 text-white px-6 inline-flex items-center gap-2">
          <i class="fas fa-plus"></i>
          <span>Registrar primer gasto</span>
        </a>
      </div>
      {% endif %}
    </div>

    <!-- GRÁFICO POR CATEGORÍA (Derecha - 1/3) -->
    <div class="w-full lg:w-1/3">
      <div class="flex flex-col gap-4 p-6 bg-white rounded-xl border border-gray-200 shadow-sm">
        
        <p class="text-gray-900 text-xl font-bold">Gastos por Categoría  ({{ mes_nombre }})</p>

        <!-- Gráfico Circular -->
        <div class="relative w-full aspect-square flex items-center justify-center">
          <canvas id="categoriasChart" class="w-full h-full"></canvas>
          
          <!-- Total en el centro -->
          <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <span class="text-gray-500 text-sm">Total</span>
            <span class="text-gray-900 text-2xl font-bold">
              ${{ total_general_grafico|floatformat:2 }}
            </span>
          </div>
        </div>

        <!-- Lista de Categorías -->
        <div class="flex flex-col gap-2 mt-2">
          {% for item in gastos_por_categoria %}
          <div class="flex justify-between items-center text-sm hover:bg-gray-100 p-2 rounded-lg transition-colors cursor-pointer">
            <div class="flex items-center gap-2">
              <!-- Color desde el backend -->
              <span class="w-3 h-3 rounded-full" style="background-color: {{ item.color }};"></span>
              
              <!-- Ícono desde el backend -->
              <i class="{{ item.icono }} {{ item.color_icono }} mr-1"></i>
              
              <span class="text-gray-700">{{ item.categoria }}</span>
            </div>
            <span class="font-medium text-gray-900">{{ item.porcentaje }}%</span>
          </div>
          {% empty %}
          <p class="text-gray-500 text-center text-sm py-4">
            Sin datos disponibles
          </p>
          {% endfor %}
        </div>

      </div>

      <!-- Paginación -->
      {% if is_paginated %}
      <div class="mt-4 flex justify-center">
        <div class="flex gap-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" 
            class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-700 transition">
            Anterior
          </a>
          {% endif %}
          
          <span class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium">
            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" 
            class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-700 transition">
            Siguiente
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

    </div>

  </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Toggle de filtros
  function toggleFiltros() {
    const panel = document.getElementById('filtrosPanel');
    panel.classList.toggle('hidden');
  }

  // Configurar gráfico de dona
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('categoriasChart');
    
    if (ctx) {
      const categoriasData = [
        {% for item in gastos_por_categoria %}
        {
          categoria: '{{ item.categoria }}',
          total: parseFloat('{{ item.total }}'),
          porcentaje: parseFloat('{{ item.porcentaje }}'),
          color: '{{ item.color}}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      
      if (categoriasData.length > 0) {
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: categoriasData.map(item => item.categoria),
            datasets: [{
              data: categoriasData.map(item => item.total),
              backgroundColor: categoriasData.map(item => item.color),
              borderWidth: 4,
              borderColor: '#fff',
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: {
              padding: 0
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percentage = categoriasData[context.dataIndex].porcentaje;
                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                  }
                }
              }
            },
            cutout: '75%'
          }
        });
      }
    }
  });
</script>

{% endblock %}