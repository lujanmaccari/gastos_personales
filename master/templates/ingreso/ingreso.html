{% extends 'layout/frame.html' %}

{% block title %}Ingresos{% endblock %}
{% block sectionTitle %}Mis Ingresos{% endblock %}

{% block nuevo_modal_url %}
  {% url 'ingresos_create' %}
{% endblock %}

{% block contenido_tabla %}

<div class="w-full space-y-6">

  <!-- LAYOUT PRINCIPAL: 2 COLUMNAS -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- COLUMNA IZQUIERDA: Cards de resumen y gráfico -->
    <div class="lg:col-span-1 space-y-6">

      <!-- Card 1: Total Ingresos Mensual -->
      <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm">
        <p class="text-gray-900 text-lg font-bold mb-6">
          Total Ingresos ({{ mes_nombre }})
        </p>

        <div class="flex flex-col gap-3">
          <p class="text-gray-900 text-5xl font-bold">
            ${{ total_ingresos_mensual|floatformat:2 }}
          </p>

          {% if variacion_porcentual >= 0 %}
          <div class="flex items-center gap-1 text-green-600 text-sm font-medium">
            <i class="fas fa-arrow-up text-xs"></i>
            <span>{{ variacion_porcentual|floatformat:1 }}% vs mes anterior</span>
          </div>
          {% else %}
          <div class="flex items-center gap-1 text-red-600 text-sm font-medium">
            <i class="fas fa-arrow-down text-xs"></i>
            <span>{{ variacion_porcentual|floatformat:1 }}% vs mes anterior</span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Card 2: Ingresos por Fuente (Gráfico) -->
      <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm">
        <p class="text-gray-900 text-lg font-bold mb-6">
          Ingresos por Fuente
        </p>

        <!-- Gráfico de Dona -->
        <div class="relative w-full aspect-square flex items-center justify-center mb-6">
          <canvas id="fuentesChart" class="w-full h-full"></canvas>

          <!-- Total en el centro -->
          <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <span class="text-gray-500 text-xs">Total</span>
            <span class="text-gray-900 text-3xl font-bold">
              ${{ total_general|floatformat:2 }}
            </span>
          </div>
        </div>

        <!-- Lista de Fuentes con Porcentajes e Íconos -->
        <div class="flex flex-col gap-2">
          {% for item in ingresos_por_fuente %}
          <div class="flex justify-between items-center hover:bg-gray-50 p-2 rounded-lg transition-colors">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full" style="background-color: {{ item.color }};"></span>
              
              <!-- Ícono según la fuente -->
              {% if item.fuente == "Sueldo" or item.fuente == "Salario" %}
                <i class="fas fa-briefcase text-cyan-500 text-sm"></i>
              {% elif item.fuente == "Freelance" %}
                <i class="fas fa-laptop-code text-amber-500 text-sm"></i>
              {% elif item.fuente == "Devoluciones" or item.fuente == "Devolución" %}
                <i class="fas fa-undo text-lime-500 text-sm"></i>
              {% elif item.fuente == "Inversiones" %}
                <i class="fas fa-chart-line text-blue-500 text-sm"></i>
              {% elif item.fuente == "Bonificación" or item.fuente == "Bono" %}
                <i class="fas fa-gift text-purple-500 text-sm"></i>
              {% else %}
                <i class="fas fa-dollar-sign text-gray-500 text-sm"></i>
              {% endif %}
              
              <span class="text-gray-700 text-sm font-medium">{{ item.fuente }}</span>
            </div>
            <span class="font-semibold text-gray-900 text-sm">{{ item.porcentaje }}%</span>
          </div>
          {% empty %}
          <p class="text-gray-500 text-center text-sm py-4">
            Sin datos disponibles
          </p>
          {% endfor %}
        </div>
      </div>

    </div>

    <!-- COLUMNA DERECHA: Tabla de Ingresos Recientes -->
    <div class="lg:col-span-2">

      <!-- Header con Filtros -->
      <div class="flex justify-between items-center mb-4">
        <p class="text-gray-900 text-xl font-bold">Ingresos Recientes</p>

        <button 
          onclick="toggleFiltros()" 
          class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors">
          <i class="fas fa-filter"></i>
          <span>Filtros</span>
        </button>
      </div>

      <!-- Panel de Filtros (Colapsable) -->
      <div id="filtrosPanel" class="hidden mb-4">
        <div class="p-4 bg-white border border-gray-200 rounded-xl">
          <form method="get" action="{% url 'ingresos' %}" 
                class="grid grid-cols-1 md:grid-cols-5 gap-4">

            <!-- Filtro: Fecha -->
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Fecha</label>
              <input 
                type="date" 
                name="fecha" 
                value="{{ filtro_fecha }}"
                class="input w-full bg-gray-50 border-gray-300"
                placeholder="mm/dd/yyyy"/>
            </div>

            <!-- Filtro: Fuente -->
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Fuente</label>
              <select 
                name="fuente" 
                class="input w-full bg-gray-50 border-gray-300">
                <option value="">Todas</option>
                {% for fuente in fuentes_disponibles %}
                <option value="{{ fuente.id }}"
                  {% if filtro_fuente == fuente.id|stringformat:"s" %}selected{% endif %}>
                  {{ fuente.nombre }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Filtro: Moneda -->
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Moneda</label>
              <select 
                name="moneda" 
                class="input w-full bg-gray-50 border-gray-300">
                <option value="">Todas</option>
                {% for moneda in monedas_disponibles %}
                <option value="{{ moneda.id }}"
                  {% if filtro_moneda == moneda.id|stringformat:"s" %}selected{% endif %}>
                  {{ moneda.abreviatura }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Filtro: Monto -->
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Monto mín.</label>
              <input 
                type="number" 
                step="0.01"
                name="monto_min" 
                value="{{ filtro_monto_min }}"
                class="input w-full bg-gray-50 border-gray-300"
                placeholder="Ej: 1000"/>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Monto máx.</label>
              <input 
                type="number" 
                step="0.01"
                name="monto_max" 
                value="{{ filtro_monto_max }}"
                class="input w-full bg-gray-50 border-gray-300"
                placeholder="Ej: 5000"/>
            </div>

            <!-- Botones -->
            <div class="md:col-span-5 flex gap-2 justify-end">
              <button type="submit" class="btn bg-blue-500 hover:bg-blue-600 text-white px-6">
                <i class="fas fa-search mr-2"></i> Aplicar
              </button>

              {% if filtro_fecha or filtro_fuente or filtro_monto_min or filtro_monto_max or filtro_moneda %}
              <a href="{% url 'ingresos' %}" 
                 class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 px-6">
                <i class="fas fa-times mr-2"></i> Limpiar
              </a>
              {% endif %}
            </div>

          </form>
        </div>
      </div>

      <!-- Tabla de Ingresos -->
      {% if ingresos %}
      <div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-4 py-3 text-left text-gray-600 font-medium">Fecha</th>
              <th class="px-4 py-3 text-left text-gray-600 font-medium">Fuente</th>
              <th class="px-4 py-3 text-left text-gray-600 font-medium">Moneda</th>
              <th class="px-4 py-3 text-right text-gray-600 font-medium">Monto</th>
              <th class="px-4 py-3 text-left text-gray-600 font-medium">Descripción</th>
              <th class="px-4 py-3 text-center text-gray-600 font-medium">Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for ingreso in ingresos %}
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
              
              <!-- Fecha -->
              <td class="px-4 py-4 text-gray-600">
                {{ ingreso.fecha|date:"d/m/Y" }}
              </td>

              <!-- Fuente con Badge e Ícono -->
              <td class="px-4 py-4">
                <div class="flex items-center gap-2">
                  {% if ingreso.fuente.nombre == "Sueldo" or ingreso.fuente.nombre == "Salario" %}
                    <i class="fas fa-briefcase text-cyan-500"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium text-cyan-800 bg-cyan-100">
                      {{ ingreso.fuente.nombre }}
                    </span>
                  {% elif ingreso.fuente.nombre == "Freelance" %}
                    <i class="fas fa-laptop-code text-amber-500"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium text-amber-800 bg-amber-100">
                      {{ ingreso.fuente.nombre }}
                    </span>
                  {% elif "Devoluc" in ingreso.fuente.nombre %}
                    <i class="fas fa-undo text-lime-500"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium text-lime-800 bg-lime-100">
                      {{ ingreso.fuente.nombre }}
                    </span>
                  {% elif ingreso.fuente.nombre == "Inversiones" %}
                    <i class="fas fa-chart-line text-blue-500"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium text-blue-800 bg-blue-100">
                      {{ ingreso.fuente.nombre }}
                    </span>
                  {% elif "Bon" in ingreso.fuente.nombre %}
                    <i class="fas fa-gift text-purple-500"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium text-purple-800 bg-purple-100">
                      {{ ingreso.fuente.nombre }}
                    </span>
                  {% else %}
                    <i class="fas fa-dollar-sign text-gray-500"></i>
                    <span class="rounded-lg px-3 py-1 text-sm font-medium text-gray-800 bg-gray-100">
                      {{ ingreso.fuente.nombre }}
                    </span>
                  {% endif %}
                </div>
              </td>

              <!-- Moneda -->
              <td class="px-4 py-4 text-left text-gray-600">
                {{ request.user.moneda.abreviatura|default:"ARS" }}
              </td>

              <!-- Monto -->
              <td class="px-4 py-4 text-right font-semibold text-gray-900">
                ${{ ingreso.monto|floatformat:2 }}
              </td>

              <!-- Descripción -->
              <td class="px-4 py-3 text-gray-600">
                {{ ingreso.descripcion|default:"—"|truncatewords:8 }}
              </td>

              <!-- Acciones -->
              <td class="px-4 py-3">
                <div class="flex justify-center gap-3">
                  <a href="{% url 'ingresos_update' ingreso.id %}" 
                    class="text-blue-500 hover:text-blue-700 transition"
                    title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'ingresos_delete' ingreso.id %}" 
                    class="text-red-500 hover:text-red-700 transition"
                    title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
      <div class="mt-4 flex justify-center">
        <div class="flex gap-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" 
             class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-700 transition">
            Anterior
          </a>
          {% endif %}
          
          <span class="px-4 py-2 bg-blue-500 text-white rounded-lg font-medium">
            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" 
             class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg text-gray-700 transition">
            Siguiente
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% else %}
      <!-- Estado vacío -->
      <div class="text-center py-16 bg-white border border-gray-200 rounded-xl">
        <i class="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
        <p class="text-gray-500 text-lg mb-4">No hay ingresos registrados</p>
        <a href="{% url 'ingresos_create' %}" 
           class="btn bg-blue-500 hover:bg-blue-600 text-white px-6 inline-flex items-center gap-2">
          <i class="fas fa-plus"></i>
          <span>Crear primer ingreso</span>
        </a>
      </div>
      {% endif %}

    </div>

  </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Toggle de filtros
  function toggleFiltros() {
    const panel = document.getElementById('filtrosPanel');
    panel.classList.toggle('hidden');
  }

  // Configurar gráfico
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('fuentesChart');
    
    if (ctx) {
      const colores = [
        '#06B6D4',  // Cyan
        '#F59E0B',  // Amarillo 
        '#84CC16',  // Lima
        '#3B82F6',  // Azul
        '#8B5CF6',  // Violeta
        '#EF4444',  // Rojo
      ];
      
      const fuentesData = [
        {% for item in ingresos_por_fuente %}
        {
          fuente: '{{ item.fuente }}',
          total: parseFloat('{{ item.total }}'),
          porcentaje: parseFloat('{{ item.porcentaje }}')
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
      
      if (fuentesData.length > 0) {
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: fuentesData.map(item => item.fuente),
            datasets: [{
              data: fuentesData.map(item => item.total),
              backgroundColor: colores.slice(0, fuentesData.length),
              borderWidth: 4,
              borderColor: '#fff',
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { 
                display: true,
                position: 'bottom',
                labels: {
                  padding: 15,
                  font: {
                    size: 12
                  },
                  generateLabels: function(chart) {
                    const data = chart.data;
                    return data.labels.map((label, i) => ({
                      text: label,
                      fillStyle: data.datasets[0].backgroundColor[i],
                      hidden: false,
                      index: i
                    }));
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percentage = fuentesData[context.dataIndex].porcentaje;
                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                  }
                }
              }
            },
            cutout: '70%'
          }
        });
      }
    }
  });
</script>

{% endblock %}