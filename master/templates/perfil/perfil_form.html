{% extends 'layout/frame.html' %}

{% load static %}

{% block title %}Editar Perfil{% endblock %}
{% block sectionTitle %}Editar Perfil{% endblock %}

{% block content %}
<main class="max-w-[900px] mx-auto p-6">
  <form method="post" enctype="multipart/form-data" class="bg-white rounded-xl p-6 shadow-sm">
    {% csrf_token %}
    <div class="grid gap-6 md:grid-cols-2">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Nombre</label>
        <input name="first_name" value="{{ request.user.first_name }}" class="w-full p-3 rounded-lg border" />
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">Apellido</label>
        <input name="last_name" value="{{ request.user.last_name }}" class="w-full p-3 rounded-lg border" />
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">Correo electrónico</label>
        <input name="email" value="{{ request.user.email }}" type="email" class="w-full p-3 rounded-lg border" />
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">Avatar</label>
        <div class="flex items-center gap-4">
          <div id="avatarPreview" class="w-24 h-24 rounded-full bg-slate-200 bg-center bg-cover">
            {% if perfil.avatar %}<img src="{{ perfil.avatar.url }}" class="w-24 h-24 rounded-full object-cover">{% endif %}
          </div>
          {{ form.avatar }}
        </div>
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">Moneda</label>
        {{ form.moneda }}
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">Límite de gasto mensual (%)</label>
        <input id="limitRangeForm" type="range" min="0" max="100" value="{{ perfil.limite_gasto_mensual }}" class="w-full" />
        <input type="hidden" name="limite_gasto_mensual" id="limitHidden" value="{{ perfil.limite_gasto_mensual }}" />
        <div class="text-right text-sm text-gray-600 mt-1"><span id="limitPercent">{{ perfil.limite_gasto_mensual }}</span>%</div>
      </div>
    </div>

    <div class="flex justify-end gap-3 mt-6">
      <a href="{% url 'perfil_detail' %}" class="px-4 py-2 rounded-lg bg-gray-200">Cancelar</a>
      <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-bold">Guardar</button>
    </div>
  </form>
</main>

<script>
  const avatarInput = document.querySelector('input[name="avatar"]');
  const preview = document.getElementById('avatarPreview');
  if (avatarInput && preview) {
    avatarInput.addEventListener('change', function(e){
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){ preview.style.backgroundImage = `url(${ev.target.result})`; }
      reader.readAsDataURL(f);
    });
  }

  const range = document.getElementById('limitRangeForm');
  const hidden = document.getElementById('limitHidden');
  const pct = document.getElementById('limitPercent');
  if (range && hidden && pct) {
    range.addEventListener('input', (e)=>{ hidden.value = e.target.value; pct.textContent = e.target.value; });
  }
</script>
{% endblock content %}
