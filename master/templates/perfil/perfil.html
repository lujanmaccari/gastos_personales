{% extends "base.html" %}
{% load static %}

{% block title %}Mi Perfil{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#F5F7FB] px-6 py-6">
  <div class="max-w-5xl mx-auto space-y-8">

    <!-- MENSAJES -->
    {% if messages %}
    <div class="space-y-3">
      {% for message in messages %}
      <div
        class="
          px-4 py-3 rounded-xl shadow-sm
          {% if message.tags == 'success' %}bg-green-100 text-green-700
          {% elif message.tags == 'error' %}bg-red-100 text-red-700
          {% else %}bg-blue-100 text-blue-700{% endif %}
        ">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}

    

    <!-- CABECERA PERFIL -->
    <div class="bg-white rounded-3xl shadow-sm px-8 py-6 flex flex-col md:flex-row md:items-center md:justify-between gap-6">
      <div class="flex items-center gap-5">
        {% if perfil.avatar %}
          <img src="{{ perfil.avatar.url }}" class="w-24 h-24 rounded-full object-cover shadow">
        {% else %}
          <div class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-4xl">ğŸ‘¤</div>
        {% endif %}

        <div>
          <p class="text-2xl font-bold text-slate-900">{{ request.user.first_name }} {{ request.user.last_name }}</p>
          <p class="text-sm text-slate-500">{{ request.user.email }}</p>
        </div>
      </div>

      <div class="flex gap-3">
        <a href="{% url 'logout' %}" class="px-5 py-2.5 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200">
          Cerrar SesiÃ³n
        </a>

        <a href="{% url 'perfil_delete' %}"
           class="px-5 py-2.5 rounded-xl bg-red-100 text-red-600 font-semibold hover:bg-red-200">
          Eliminar Cuenta
        </a>
      </div>
    </div>

    <!-- FORMULARIO PERFIL -->
    <form method="post" enctype="multipart/form-data" action="{% url 'perfil_update' %}"
          class="bg-white rounded-3xl shadow-sm p-8 space-y-6">
      {% csrf_token %}

      <h2 class="text-xl font-semibold mb-4">InformaciÃ³n Personal</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label class="text-slate-600 text-sm">Nombre</label>
          <input name="first_name" value="{{ request.user.first_name }}"
                 class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-[#4F46E5]">
        </div>

        <div>
          <label class="text-slate-600 text-sm">Apellido</label>
          <input name="last_name" value="{{ request.user.last_name }}"
                 class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-[#4F46E5]">
        </div>

        <div>
          <label class="text-slate-600 text-sm">Correo electrÃ³nico</label>
          <input name="email" type="email" value="{{ request.user.email }}"
                 class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:ring-[#4F46E5]">
        </div>

        <div>
          <label class="text-slate-600 text-sm">Moneda predeterminada</label>
          <select name="moneda"
                  class="w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-white focus:ring-[#4F46E5]">
            <option value="">Seleccionar...</option>
            {% for m in monedas %}
            <option value="{{ m.id }}" {% if request.user.moneda_id == m.id %}selected{% endif %}>
              {{ m.moneda }} ({{ m.abreviatura }})
            </option>
            {% endfor %}
          </select>
        </div>

      </div>

      <!-- SEGURIDAD -->
      <h2 class="text-xl font-semibold pt-4 border-t">Seguridad</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <div>
          <label class="text-slate-600 text-sm">Nueva contraseÃ±a</label>
          <div class="relative">
            <input id="id_password1" name="password1" type="password"
                   class="w-full px-4 py-2.5 rounded-xl border border-slate-200 pr-10">
            <button type="button"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                    onclick="togglePassword('id_password1')">ğŸ‘</button>
          </div>
        </div>

        <div>
          <label class="text-slate-600 text-sm">Repetir contraseÃ±a</label>
          <div class="relative">
            <input id="id_password2" name="password2" type="password"
                   class="w-full px-4 py-2.5 rounded-xl border border-slate-200 pr-10">
            <button type="button"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                    onclick="togglePassword('id_password2')">ğŸ‘</button>
          </div>
        </div>

      </div>

      <!-- AVATAR -->
      <div>
        <label class="text-slate-600 text-sm">Avatar</label>
        <div class="flex items-center gap-4">
          <div class="w-20 h-20 rounded-full bg-gray-200 overflow-hidden">
            {% if perfil.avatar %}
              <img src="{{ perfil.avatar.url }}" class="w-full h-full object-cover">
            {% endif %}
          </div>
          {{ form.avatar }}
        </div>
      </div>

      <button type="submit"
              class="mt-4 px-8 py-3 rounded-xl bg-[#4F46E5] text-white font-semibold hover:bg-[#4338CA]">
        Guardar Cambios
      </button>
    </form>

    <!-- MONEDAS -->
    <div class="bg-white rounded-3xl shadow-sm p-8 space-y-4">
      <h2 class="text-xl font-semibold">Monedas</h2>

      {% if monedas %}
        {% for m in monedas %}
        <div class="flex items-center justify-between px-4 py-2 bg-slate-50 rounded-xl border">
          <span>{{ m.moneda }} ({{ m.abreviatura }})</span>

          <form method="post" action="{% url 'moneda_delete' m.id %}">
            {% csrf_token %}
            <button class="text-red-500 hover:text-red-700 text-lg" title="Eliminar">ğŸ—‘</button>
          </form>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-slate-400 text-sm">TodavÃ­a no hay monedas.</p>
      {% endif %}

      <form method="post" action="{% url 'moneda_create' %}" class="grid grid-cols-2 gap-4">
        {% csrf_token %}
        <input name="moneda" placeholder="Nombre"
               class="px-4 py-2.5 rounded-xl border border-slate-200">
        <input name="abreviatura" placeholder="Abrev."
               class="px-4 py-2.5 rounded-xl border border-slate-200">
        <button class="col-span-2 px-5 py-2.5 bg-[#4F46E5] text-white rounded-xl">AÃ±adir Nueva</button>
      </form>
    </div>

    <!-- FUENTES -->
    <div class="bg-white rounded-3xl shadow-sm p-8 space-y-4">
      <h2 class="text-xl font-semibold">Fuentes de ingreso</h2>

      {% if fuentes %}
        {% for f in fuentes %}
        <div class="flex items-center justify-between px-4 py-2 bg-slate-50 rounded-xl border">
          <span>{{ f.nombre }}</span>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-slate-400 text-sm">No hay fuentes.</p>
      {% endif %}

      <form method="post" action="{% url 'fuente_create' %}" class="grid grid-cols-2 gap-4">
        {% csrf_token %}
        <input name="nombre" placeholder="Nueva fuente"
               class="px-4 py-2.5 rounded-xl border border-slate-200">
        <button class="col-span-2 px-5 py-2.5 bg-[#4F46E5] text-white rounded-xl">AÃ±adir Nueva</button>
      </form>
    </div>

  </div>
</div>

<script>
function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === "password" ? "text" : "password";
}
</script>

{% endblock %}